<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi des Appels d'Offres</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #3b82f6;
            --accent-color: #ef4444;
            --light-color: #f8fafc;
            --dark-color: #1e293b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --pdf-color: #ef4444;
            --excel-color: #10b981;
            --overview-color: #3b82f6;
            --inprogress-color: #f59e0b;
            --completed-color: #10b981;
            --alert-color: #ef4444;
            --border-radius: 8px;
            --box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f8fafc;
            color: #1e293b;
            line-height: 1.5;
            font-size: 14px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 16px 0;
            margin-bottom: 24px;
            box-shadow: var(--box-shadow);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.025em;
        }

        .tabs-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: white;
        }

        .tab-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--box-shadow);
        }

        .tab-btn.active {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .tab-overview {
            background-color: var(--overview-color);
        }

        .tab-inprogress {
            background-color: var(--inprogress-color);
        }

        .tab-completed {
            background-color: var(--completed-color);
        }

        .tab-alerts {
            background-color: var(--alert-color);
        }

        .tab-btn.active {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .search-section {
            background-color: white;
            padding: 16px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            margin-bottom: 16px;
            transition: var(--transition);
        }

        .search-section:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .search-form {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--dark-color);
        }

        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            transition: var(--transition);
            background-color: #f8fafc;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background-color: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--box-shadow);
        }

        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-pdf {
            background-color: var(--pdf-color);
            color: white;
        }

        .btn-pdf:hover {
            background-color: #c0392b;
        }

        .btn-excel {
            background-color: var(--excel-color);
            color: white;
        }

        .btn-excel:hover {
            background-color: #27ae60;
        }

        .actions-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
        }

        .table-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: var(--primary-color);
            color: white;
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.875rem;
        }

        th {
    font-weight: 600;
    background-color: var(--primary-color);
    color: white;
}

        tbody tr {
            transition: var(--transition);
        }

        tbody tr:hover {
            background-color: #f1f5f9;
            transform: translateX(2px);
        }

        .object-cell {
            width: 300px;
            max-width: 300px;
            word-wrap: break-word;
            text-align: justify;
        }

        .observations-cell {
            width: 350px;
            max-width: 350px;
            word-wrap: break-word;
            text-align: justify;
        }

        .status-select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: white;
            cursor: pointer;
            transition: var(--transition);
        }

        .status-select:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }

        .pagination-info {
            color: #666;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .page-btn:hover:not(:disabled) {
            background-color: #f0f0f0;
        }

        .page-btn.active {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 90%;
            max-width: 600px;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .form-row {
            margin-bottom: 15px;
        }

        .alert-section {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }

        .alert-form {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .alert-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }

        .alert-info {
            flex: 1;
        }

        .alert-actions {
            display: flex;
            gap: 10px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error-message {
            background-color: #fee;
            border: 1px solid #fcc;
            border-radius: var(--border-radius);
            padding: 15px;
            margin: 10px 0;
            color: #c33;
        }

        .success-message {
            background-color: #efe;
            border: 1px solid #cfc;
            border-radius: var(--border-radius);
            padding: 15px;
            margin: 10px 0;
            color: #363;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .search-form {
                flex-direction: column;
            }
            
            .actions-section {
                flex-direction: column;
                gap: 15px;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            table {
                min-width: 900px;
            }
            
            .pagination {
                flex-direction: column;
                gap: 15px;
            }
            
            .alert-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .alert-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <h1>Suivi des Appels d'Offres</h1>
                <div>
                    <button class="btn btn-primary" id="addBtn">
                        <i class="fas fa-plus"></i> Nouvel Appel d'Offres
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="firebaseStatus"></div>

        <section class="tabs-section">
            <button class="tab-btn tab-overview active" data-tab="overview">
                <i class="fas fa-chart-bar"></i> Vue d'ensemble
            </button>
            <button class="tab-btn tab-inprogress" data-tab="inprogress">
                <i class="fas fa-tasks"></i> Ouverture en cours
            </button>
            <button class="tab-btn tab-completed" data-tab="completed">
                <i class="fas fa-check-circle"></i> DAO achevés
            </button>
            <button class="tab-btn tab-alerts" data-tab="alerts">
                <i class="fas fa-bell"></i> Alertes
            </button>
        </section>

        <!-- Vue d'ensemble -->
        <div class="tab-content active" id="overview-content">
            <section class="search-section">
                <form class="search-form" id="searchForm">
                    <div class="form-group">
                        <label for="searchGlobal">Rechercher</label>
                        <input type="text" id="searchGlobal" placeholder="Rechercher par DAO N°, Objet ou Exercice">
                    </div>
                    <div class="form-group">
                        <label for="searchStatus">État d'avancement</label>
                        <select id="searchStatus">
                            <option value="">Tous les états</option>
                            <option value="en cours d'élaboration">En cours d'élaboration</option>
                            <option value="déposé pour signature du Directeur">Déposé pour signature du Directeur</option>
                            <option value="envoyé aux membres de la commission">Envoyé aux membres de la commission</option>
                            <option value="appel d'offres publié">Appel d'offres publié</option>
                            <option value="examen des dossier administratifs et technique">Examen des dossier administratifs et technique</option>
                            <option value="examen de la documentation technique">Examen de la documentation technique</option>
                            <option value="examen des offres techniques">Examen des offres techniques</option>
                            <option value="examen des offres financières">Examen des offres financières</option>
                            <option value="demande de complément envoyée">Demande de complément envoyée</option>
                            <option value="complément de dossier reçu à examiner">Complément de dossier reçu à examiner</option>
                            <option value="complément de dossier encours d'examination">Complément de dossier encours d'examination</option>
                            <option value="échantillons envoyées à la sous commission">Échantillons envoyées à la sous commission</option>
                            <option value="Résultat & Extrait de PV publiés">Résultat & Extrait de PV publiés</option>
                            <option value="marché en cours d'élaboration">Marché en cours d'élaboration</option>
                            <option value="marché envoyé à la société pour signature">Marché envoyé à la société pour signature</option>
                            <option value="marché envoyé pour signature de la partie technique">Marché envoyé pour signature de la partie technique</option>
                            <option value="marché déposé pour signature du directeur">Marché déposé pour signature du directeur</option>
                            <option value="marché envoyé au Contrôleur d'Etat pour visa">Marché envoyé au Contrôleur d'Etat pour visa</option>
                            <option value="marché visé reçu">Marché visé reçu</option>
                            <option value="marché approuvé notifié à la société">Marché approuvé notifié à la société</option>
                            <option value="ordre de service de commencement à notifier">Ordre de service de commencement à notifier</option>
                            <option value="marché envoyé au service utilisateur">Marché envoyé au service utilisateur</option>
                        </select>
                    </div>
                </form>
            </section>

            <section class="actions-section">
                <div class="export-buttons">
                    <button class="btn btn-pdf" id="printPdfBtn">
                        <i class="fas fa-file-pdf"></i> Imprimer PDF
                    </button>
                    <button class="btn btn-excel" id="printExcelBtn">
                        <i class="fas fa-file-excel"></i> Exporter Excel
                    </button>
                </div>
                <div class="pagination-controls" id="paginationControls">
                    <!-- Les contrôles de pagination seront générés ici -->
                </div>
            </section>

            <section class="table-container">
                <table id="aoTable">
                    <thead>
                        <tr>
                            <th>Exercice</th>
                            <th>DAO N°</th>
                            <th>Objet</th>
                            <th>État d'Avancement</th>
                            <th>Observations</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="6" class="loading">
                                <i class="fas fa-spinner fa-spin"></i> Chargement des données...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <section class="pagination">
                <div class="pagination-info" id="paginationInfo">
                    Chargement...
                </div>
            </section>
        </div>

        <!-- Ouverture en cours -->
        <div class="tab-content" id="inprogress-content">
            <section class="search-section">
                <h3>Appels d'offres en cours d'ouverture</h3>
                <p>Cette section affiche les appels d'offres en phase d'examen et d'évaluation.</p>
            </section>

            <section class="actions-section">
                <div class="export-buttons">
                    <button class="btn btn-pdf" id="printPdfInprogressBtn">
                        <i class="fas fa-file-pdf"></i> Imprimer PDF
                    </button>
                    <button class="btn btn-excel" id="printExcelInprogressBtn">
                        <i class="fas fa-file-excel"></i> Exporter Excel
                    </button>
                </div>
                <div class="pagination-controls" id="paginationInprogressControls">
                    <!-- Les contrôles de pagination seront générés ici -->
                </div>
            </section>

            <section class="table-container">
                <table id="inprogressTable">
                    <thead>
                        <tr>
                            <th>Exercice</th>
                            <th>DAO N°</th>
                            <th>Objet</th>
                            <th>État d'Avancement</th>
                            <th>Observations</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inprogressTableBody">
                        <tr>
                            <td colspan="6" class="loading">
                                <i class="fas fa-spinner fa-spin"></i> Chargement des données...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <section class="pagination">
                <div class="pagination-info" id="paginationInprogressInfo">
                    Chargement...
                </div>
            </section>
        </div>

        <!-- DAO achevés -->
        <div class="tab-content" id="completed-content">
            <section class="search-section">
                <h3>Appels d'offres achevés</h3>
                <p>Cette section affiche les appels d'offres dont le processus est terminé et le marché est en cours.</p>
            </section>

            <section class="actions-section">
                <div class="export-buttons">
                    <button class="btn btn-pdf" id="printPdfCompletedBtn">
                        <i class="fas fa-file-pdf"></i> Imprimer PDF
                    </button>
                    <button class="btn btn-excel" id="printExcelCompletedBtn">
                        <i class="fas fa-file-excel"></i> Exporter Excel
                    </button>
                </div>
                <div class="pagination-controls" id="paginationCompletedControls">
                    <!-- Les contrôles de pagination seront générés ici -->
                </div>
            </section>

            <section class="table-container">
                <table id="completedTable">
                    <thead>
                        <tr>
                            <th>Exercice</th>
                            <th>DAO N°</th>
                            <th>Objet</th>
                            <th>État d'Avancement</th>
                            <th>Observations</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="completedTableBody">
                        <tr>
                            <td colspan="6" class="loading">
                                <i class="fas fa-spinner fa-spin"></i> Chargement des données...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <section class="pagination">
                <div class="pagination-info" id="paginationCompletedInfo">
                    Chargement...
                </div>
            </section>
        </div>

        <!-- Alertes -->
        <div class="tab-content" id="alerts-content">
            <section class="alert-section">
                <h3>Gestion des Alertes</h3>
                <p>Ajoutez des appels d'offres nécessitant une attention particulière.</p>
                
                <form class="alert-form" id="alertForm">
                    <div class="form-group">
                        <label for="alertDaoSelect">Sélectionner un appel d'offres</label>
                        <select id="alertDaoSelect">
                            <option value="">Choisir un appel d'offres</option>
                        </select>
                    </div>
                    <div class="form-group" style="align-self: flex-end;">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Ajouter à la liste d'alertes
                        </button>
                    </div>
                </form>

                <div id="alertsList">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Chargement des alertes...
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Modal pour ajouter/modifier un appel d'offres -->
    <div class="modal" id="aoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Nouvel Appel d'Offres</h2>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <form id="aoForm">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <label for="exercise">Exercice</label>
                    <input type="text" id="exercise" required>
                </div>
                <div class="form-row">
                    <label for="daoNumber">DAO N°</label>
                    <input type="text" id="daoNumber" required>
                </div>
                <div class="form-row">
                    <label for="object">Objet</label>
                    <input type="text" id="object" required>
                </div>
                <div class="form-row">
                    <label for="status">État d'Avancement</label>
                    <select id="status" required>
                        <option value="">Sélectionnez un état</option>
                        <option value="en cours d'élaboration">En cours d'élaboration</option>
                        <option value="déposé pour signature du Directeur">Déposé pour signature du Directeur</option>
                        <option value="envoyé aux membres de la commission">Envoyé aux membres de la commission</option>
                        <option value="appel d'offres publié">Appel d'offres publié</option>
                        <option value="examen des dossier administratifs et technique">Examen des dossier administratifs et technique</option>
                        <option value="examen de la documentation technique">Examen de la documentation technique</option>
                        <option value="examen des offres techniques">Examen des offres techniques</option>
                        <option value="examen des offres financières">Examen des offres financières</option>
                        <option value="demande de complément envoyée">Demande de complément envoyée</option>
                        <option value="complément de dossier reçu à examiner">Complément de dossier reçu à examiner</option>
                        <option value="complément de dossier encours d'examination">Complément de dossier encours d'examination</option>
                        <option value="échantillons envoyées à la sous commission">Échantillons envoyées à la sous commission</option>
                        <option value="Résultat & Extrait de PV publiés">Résultat & Extrait de PV publiés</option>
                        <option value="marché en cours d'élaboration">Marché en cours d'élaboration</option>
                        <option value="marché envoyé à la société pour signature">Marché envoyé à la société pour signature</option>
                        <option value="marché envoyé pour signature de la partie technique">Marché envoyé pour signature de la partie technique</option>
                        <option value="marché déposé pour signature du directeur">Marché déposé pour signature du directeur</option>
                        <option value="marché envoyé au Contrôleur d'Etat pour visa">Marché envoyé au Contrôleur d'Etat pour visa</option>
                        <option value="marché visé reçu">Marché visé reçu</option>
                        <option value="marché approuvé notifié à la société">Marché approuvé notifié à la société</option>
                        <option value="ordre de service de commencement à notifier">Ordre de service de commencement à notifier</option>
                        <option value="marché envoyé au service utilisateur">Marché envoyé au service utilisateur</option>
                    </select>
                </div>
                <div class="form-row">
                    <label for="observations">Observations</label>
                    <textarea id="observations" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: var(--border-radius);"></textarea>
                </div>
                <div class="form-row" style="margin-top: 20px; text-align: right;">
                    <button type="button" class="btn btn-danger" id="cancelBtn">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB5sCeQqy4jBvSj0Abj-Pce64wgwibCPt0",
            authDomain: "suivi-des-appel-d-offres.firebaseapp.com",
            projectId: "suivi-des-appel-d-offres",
            storageBucket: "suivi-des-appel-d-offres.firebasestorage.app",
            messagingSenderId: "746414783323",
            appId: "1:746414783323:web:1102545e1ba696c056787e"
        };

        // Variables globales
        let db;
        let aoData = [];
        let alertData = [];
        let currentPage = 1;
        let currentInprogressPage = 1;
        let currentCompletedPage = 1;
        const rowsPerPage = 25;
        let filteredData = [];
        let currentTab = 'overview';

        // Éléments DOM
        const tableBody = document.getElementById('tableBody');
        const inprogressTableBody = document.getElementById('inprogressTableBody');
        const completedTableBody = document.getElementById('completedTableBody');
        const paginationInfo = document.getElementById('paginationInfo');
        const paginationInprogressInfo = document.getElementById('paginationInprogressInfo');
        const paginationCompletedInfo = document.getElementById('paginationCompletedInfo');
        const paginationControls = document.getElementById('paginationControls');
        const paginationInprogressControls = document.getElementById('paginationInprogressControls');
        const paginationCompletedControls = document.getElementById('paginationCompletedControls');
        const searchForm = document.getElementById('searchForm');
        const searchGlobal = document.getElementById('searchGlobal');
        const searchStatus = document.getElementById('searchStatus');
        const aoModal = document.getElementById('aoModal');
        const aoForm = document.getElementById('aoForm');
        const modalTitle = document.getElementById('modalTitle');
        const addBtn = document.getElementById('addBtn');
        const closeModal = document.getElementById('closeModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const printPdfBtn = document.getElementById('printPdfBtn');
        const printExcelBtn = document.getElementById('printExcelBtn');
        const printPdfInprogressBtn = document.getElementById('printPdfInprogressBtn');
        const printExcelInprogressBtn = document.getElementById('printExcelInprogressBtn');
        const printPdfCompletedBtn = document.getElementById('printPdfCompletedBtn');
        const printExcelCompletedBtn = document.getElementById('printExcelCompletedBtn');
        const alertForm = document.getElementById('alertForm');
        const alertDaoSelect = document.getElementById('alertDaoSelect');
        const alertsList = document.getElementById('alertsList');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const firebaseStatus = document.getElementById('firebaseStatus');

        // Initialisation Firebase
        function initializeFirebase() {
            try {
                // Vérifier si Firebase est disponible
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK non chargé');
                }

                // Initialiser Firebase
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                showMessage('Firebase initialisé avec succès!', 'success');
                console.log('Firebase initialisé');
                
                // Charger les données
                loadData();
                setupEventListeners();
                
            } catch (error) {
                console.error('Erreur d\'initialisation Firebase:', error);
                showMessage('Erreur d\'initialisation Firebase: ' + error.message, 'error');
                
                // Charger des données d'exemple en cas d'échec
                loadSampleData();
            }
        }

        // Afficher un message de statut
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.innerHTML = `
                <strong>${type === 'error' ? '❌ Erreur' : '✅ Succès'}:</strong> ${message}
            `;
            firebaseStatus.innerHTML = '';
            firebaseStatus.appendChild(messageDiv);
            
            // Supprimer le message après 5 secondes pour les succès
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.remove();
                }, 5000);
            }
        }

        // Charger les données d'exemple (fallback)
        function loadSampleData() {
            showMessage('Chargement des données d\'exemple...', 'info');
            
            aoData = [
                { 
                    id: '1', 
                    daoNumber: 'DAO-2023-001', 
                    object: 'Fourniture de matériel informatique', 
                    status: 'en cours d\'élaboration', 
                    observations: '', 
                    exercise: '2023' 
                },
                { 
                    id: '2', 
                    daoNumber: 'DAO-2023-002', 
                    object: 'Construction bâtiment administratif', 
                    status: 'appel d\'offres publié', 
                    observations: 'Publication dans le journal officiel', 
                    exercise: '2023' 
                },
                { 
                    id: '3', 
                    daoNumber: 'DAO-2023-003', 
                    object: 'Maintenance des équipements', 
                    status: 'examen des offres techniques', 
                    observations: '', 
                    exercise: '2023' 
                }
            ];
            
            alertData = [];
            
            // Initialiser l'interface avec les données d'exemple
            sortData();
            renderTable();
            renderInprogressTable();
            renderCompletedTable();
            updateAlertDaoSelect();
            renderAlerts();
            
            showMessage('Données d\'exemple chargées. Les modifications ne seront pas sauvegardées.', 'error');
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
        });

        // Charger les données depuis Firebase
        async function loadData() {
            try {
                showMessage('Connexion à Firebase...', 'info');
                
                // Vérifier la connexion
                await db.collection('appelsOffres').limit(1).get();
                
                showMessage('Chargement des données...', 'info');

                // Charger les appels d'offres
                const aoSnapshot = await db.collection('appelsOffres').get();
                aoData = aoSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Charger les alertes
                const alertsSnapshot = await db.collection('alertes').get();
                alertData = alertsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Initialiser l'interface
                sortData();
                renderTable();
                renderInprogressTable();
                renderCompletedTable();
                updateAlertDaoSelect();
                renderAlerts();
                
                // Configurer l'écoute en temps réel
                setupRealtimeListeners();
                
                showMessage(`Données chargées: ${aoData.length} appels d'offres, ${alertData.length} alertes`, 'success');
                
            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
                
                if (error.code === 'failed-precondition') {
                    showMessage('Erreur: Les règles Firebase ne sont pas configurées. Vérifiez la configuration dans la console Firebase.', 'error');
                } else if (error.code === 'permission-denied') {
                    showMessage('Erreur: Permission refusée. Vérifiez les règles Firebase.', 'error');
                } else {
                    showMessage('Erreur de connexion à Firebase: ' + error.message, 'error');
                }
                
                // Charger des données d'exemple en cas d'échec
                loadSampleData();
            }
        }

        // Configurer les écouteurs en temps réel
        function setupRealtimeListeners() {
            // Écouter les changements sur les appels d'offres
            db.collection('appelsOffres').onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added' || change.type === 'modified') {
                        const index = aoData.findIndex(item => item.id === change.doc.id);
                        if (index !== -1) {
                            aoData[index] = { id: change.doc.id, ...change.doc.data() };
                        } else {
                            aoData.push({ id: change.doc.id, ...change.doc.data() });
                        }
                    } else if (change.type === 'removed') {
                        aoData = aoData.filter(item => item.id !== change.doc.id);
                    }
                });
                
                sortData();
                renderTable();
                renderInprogressTable();
                renderCompletedTable();
                updateAlertDaoSelect();
            }, (error) => {
                console.error('Erreur écouteur temps réel:', error);
            });

            // Écouter les changements sur les alertes
            db.collection('alertes').onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added' || change.type === 'modified') {
                        const index = alertData.findIndex(item => item.id === change.doc.id);
                        if (index !== -1) {
                            alertData[index] = { id: change.doc.id, ...change.doc.data() };
                        } else {
                            alertData.push({ id: change.doc.id, ...change.doc.data() });
                        }
                    } else if (change.type === 'removed') {
                        alertData = alertData.filter(item => item.id !== change.doc.id);
                    }
                });
                
                renderAlerts();
            }, (error) => {
                console.error('Erreur écouteur alertes:', error);
            });
        }

        // Configuration des écouteurs d'événements
        function setupEventListeners() {
            searchGlobal.addEventListener('input', handleSearch);
            searchStatus.addEventListener('change', handleSearch);
            addBtn.addEventListener('click', openAddModal);
            closeModal.addEventListener('click', closeAoModal);
            cancelBtn.addEventListener('click', closeAoModal);
            aoForm.addEventListener('submit', handleFormSubmit);
            printPdfBtn.addEventListener('click', () => printPdf('overview'));
            printExcelBtn.addEventListener('click', () => exportToExcel('overview'));
            printPdfInprogressBtn.addEventListener('click', () => printPdf('inprogress'));
            printExcelInprogressBtn.addEventListener('click', () => exportToExcel('inprogress'));
            printPdfCompletedBtn.addEventListener('click', () => printPdf('completed'));
            printExcelCompletedBtn.addEventListener('click', () => exportToExcel('completed'));
            alertForm.addEventListener('submit', handleAlertSubmit);
            
            // Gestion des onglets
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Fermer la modal en cliquant en dehors
            window.addEventListener('click', function(event) {
                if (event.target === aoModal) {
                    closeAoModal();
                }
            });
        }

        // Changer d'onglet
        function switchTab(tabId) {
            // Désactiver tous les onglets
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Activer l'onglet sélectionné
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`${tabId}-content`).classList.add('active');
            
            currentTab = tabId;
        }

        // Trier les données par exercice (croissant) et DAO N° (décroissant)
        function sortData() {
            aoData.sort((a, b) => {
                // Trier par exercice (croissant)
                if (a.exercise !== b.exercise) {
                    return a.exercise.localeCompare(b.exercise);
                }
                // Trier par DAO N° (décroissant)
                return b.daoNumber.localeCompare(a.daoNumber);
            });
            filteredData = [...aoData];
        }

        // Rendu du tableau (Vue d'ensemble)
        function renderTable() {
            tableBody.innerHTML = '';
            
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);
            
            if (pageData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucun appel d\'offres trouvé</td></tr>';
            } else {
                pageData.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.exercise}</td>
                        <td>${item.daoNumber}</td>
                        <td class="object-cell">${item.object}</td>
                        <td>
                            <select class="status-select" data-id="${item.id}">
                                ${generateStatusOptions(item.status)}
                            </select>
                        </td>
                        <td class="observations-cell">${item.observations || ''}</td>
                        <td>
                            <button class="btn btn-primary edit-btn" data-id="${item.id}">
                                <i class="fas fa-edit"></i> Modifier
                            </button>
                            <button class="btn btn-danger delete-btn" data-id="${item.id}">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // Ajouter les écouteurs d'événements pour les boutons d'édition et suppression
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        openEditModal(id);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        deleteAo(id);
                    });
                });
                
                // Ajouter les écouteurs d'événements pour les sélecteurs de statut
                document.querySelectorAll('.status-select').forEach(select => {
                    select.addEventListener('change', function() {
                        const id = this.getAttribute('data-id');
                        const newStatus = this.value;
                        updateStatus(id, newStatus);
                    });
                });
            }
            
            updatePagination(currentPage, filteredData.length, paginationInfo, paginationControls, renderTable);
        }

        // Rendu du tableau (Ouverture en cours)
        function renderInprogressTable() {
            inprogressTableBody.innerHTML = '';
            
            // États d'avancement pour "Ouverture en cours"
            const inprogressStatuses = [
                "examen des dossier administratifs et technique",
                "examen de la documentation technique",
                "examen des offres techniques",
                "examen des offres financières",
                "demande de complément envoyée",
                "complément de dossier reçu à examiner",
                "complément de dossier encours d'examination",
                "échantillons envoyées à la sous commission"
            ];
            
            const inprogressData = aoData.filter(item => inprogressStatuses.includes(item.status));
            const startIndex = (currentInprogressPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const pageData = inprogressData.slice(startIndex, endIndex);
            
            if (pageData.length === 0) {
                inprogressTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucun appel d\'offres en cours d\'ouverture</td></tr>';
            } else {
                pageData.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.exercise}</td>
                        <td>${item.daoNumber}</td>
                        <td class="object-cell">${item.object}</td>
                        <td>
                            <select class="status-select" data-id="${item.id}">
                                ${generateStatusOptions(item.status)}
                            </select>
                        </td>
                        <td class="observations-cell">${item.observations || ''}</td>
                        <td>
                            <button class="btn btn-primary edit-btn" data-id="${item.id}">
                                <i class="fas fa-edit"></i> Modifier
                            </button>
                            <button class="btn btn-danger delete-btn" data-id="${item.id}">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </td>
                    `;
                    inprogressTableBody.appendChild(row);
                });
                
                // Ajouter les écouteurs d'événements pour les boutons d'édition et suppression
                document.querySelectorAll('#inprogressTableBody .edit-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        openEditModal(id);
                    });
                });
                
                document.querySelectorAll('#inprogressTableBody .delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        deleteAo(id);
                    });
                });
                
                // Ajouter les écouteurs d'événements pour les sélecteurs de statut
                document.querySelectorAll('#inprogressTableBody .status-select').forEach(select => {
                    select.addEventListener('change', function() {
                        const id = this.getAttribute('data-id');
                        const newStatus = this.value;
                        updateStatus(id, newStatus);
                    });
                });
            }
            
            updatePagination(currentInprogressPage, inprogressData.length, paginationInprogressInfo, paginationInprogressControls, renderInprogressTable, 'inprogress');
        }

        // Rendu du tableau (DAO achevés)
        function renderCompletedTable() {
            completedTableBody.innerHTML = '';
            
            // États d'avancement pour "DAO achevés"
            const completedStatuses = [
                "marché en cours d'élaboration",
                "marché envoyé à la société pour signature",
                "marché envoyé pour signature de la partie technique",
                "marché déposé pour signature du directeur",
                "marché envoyé au Contrôleur d'Etat pour visa",
                "marché visé reçu",
                "marché approuvé notifié à la société",
                "ordre de service de commencement à notifier",
                "marché envoyé au service utilisateur"
            ];
            
            const completedData = aoData.filter(item => completedStatuses.includes(item.status));
            const startIndex = (currentCompletedPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const pageData = completedData.slice(startIndex, endIndex);
            
            if (pageData.length === 0) {
                completedTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucun appel d\'offres achevé</td></tr>';
            } else {
                pageData.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.exercise}</td>
                        <td>${item.daoNumber}</td>
                        <td class="object-cell">${item.object}</td>
                        <td>
                            <select class="status-select" data-id="${item.id}">
                                ${generateStatusOptions(item.status)}
                            </select>
                        </td>
                        <td class="observations-cell">${item.observations || ''}</td>
                        <td>
                            <button class="btn btn-primary edit-btn" data-id="${item.id}">
                                <i class="fas fa-edit"></i> Modifier
                            </button>
                            <button class="btn btn-danger delete-btn" data-id="${item.id}">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </td>
                    `;
                    completedTableBody.appendChild(row);
                });
                
                // Ajouter les écouteurs d'événements pour les boutons d'édition et suppression
                document.querySelectorAll('#completedTableBody .edit-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        openEditModal(id);
                    });
                });
                
                document.querySelectorAll('#completedTableBody .delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        deleteAo(id);
                    });
                });
                
                // Ajouter les écouteurs d'événements pour les sélecteurs de statut
                document.querySelectorAll('#completedTableBody .status-select').forEach(select => {
                    select.addEventListener('change', function() {
                        const id = this.getAttribute('data-id');
                        const newStatus = this.value;
                        updateStatus(id, newStatus);
                    });
                });
            }
            
            updatePagination(currentCompletedPage, completedData.length, paginationCompletedInfo, paginationCompletedControls, renderCompletedTable, 'completed');
        }

        // Générer les options de statut
        function generateStatusOptions(selectedStatus) {
            const statuses = [
                "en cours d'élaboration",
                "déposé pour signature du Directeur",
                "envoyé aux membres de la commission",
                "appel d'offres publié",
                "examen des dossier administratifs et technique",
                "examen de la documentation technique",
                "examen des offres techniques",
                "examen des offres financières",
                "demande de complément envoyée",
                "complément de dossier reçu à examiner",
                "complément de dossier encours d'examination",
                "échantillons envoyées à la sous commission",
                "Résultat & Extrait de PV publiés",
                "marché en cours d'élaboration",
                "marché envoyé à la société pour signature",
                "marché envoyé pour signature de la partie technique",
                "marché déposé pour signature du directeur",
                "marché envoyé au Contrôleur d'Etat pour visa",
                "marché visé reçu",
                "marché approuvé notifié à la société",
                "ordre de service de commencement à notifier",
                "marché envoyé au service utilisateur"
            ];
            
            return statuses.map(status => 
                `<option value="${status}" ${status === selectedStatus ? 'selected' : ''}>${status}</option>`
            ).join('');
        }

        // Mise à jour de la pagination
        function updatePagination(page, totalItems, infoElement, controlsElement, renderFunction, type = 'overview') {
            const totalPages = Math.ceil(totalItems / rowsPerPage);
            
            // Mise à jour des informations
            const startIndex = (page - 1) * rowsPerPage + 1;
            const endIndex = Math.min(page * rowsPerPage, totalItems);
            infoElement.textContent = `Affichage de ${startIndex} à ${endIndex} sur ${totalItems} entrées`;
            
            // Mise à jour des contrôles
            controlsElement.innerHTML = '';
            
            // Bouton précédent
            const prevBtn = document.createElement('button');
            prevBtn.className = 'page-btn';
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevBtn.disabled = page === 1;
            prevBtn.addEventListener('click', () => {
                if (page > 1) {
                    if (type === 'inprogress') {
                        currentInprogressPage--;
                    } else if (type === 'completed') {
                        currentCompletedPage--;
                    } else {
                        currentPage--;
                    }
                    renderFunction();
                }
            });
            controlsElement.appendChild(prevBtn);
            
            // Pages
            const maxVisiblePages = 5;
            let startPage = Math.max(1, page - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-btn ${i === page ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    if (type === 'inprogress') {
                        currentInprogressPage = i;
                    } else if (type === 'completed') {
                        currentCompletedPage = i;
                    } else {
                        currentPage = i;
                    }
                    renderFunction();
                });
                controlsElement.appendChild(pageBtn);
            }
            
            // Bouton suivant
            const nextBtn = document.createElement('button');
            nextBtn.className = 'page-btn';
            nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextBtn.disabled = page === totalPages;
            nextBtn.addEventListener('click', () => {
                if (page < totalPages) {
                    if (type === 'inprogress') {
                        currentInprogressPage++;
                    } else if (type === 'completed') {
                        currentCompletedPage++;
                    } else {
                        currentPage++;
                    }
                    renderFunction();
                }
            });
            controlsElement.appendChild(nextBtn);
        }

        // Gestion de la recherche
        function handleSearch() {
            const searchTerm = searchGlobal.value.toLowerCase();
            const statusFilter = searchStatus.value;
            
            filteredData = aoData.filter(item => {
                const matchesSearch = item.daoNumber.toLowerCase().includes(searchTerm) || 
                                     item.object.toLowerCase().includes(searchTerm) || 
                                     item.exercise.toLowerCase().includes(searchTerm);
                
                const matchesStatus = statusFilter === '' || item.status === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            currentPage = 1;
            renderTable();
        }

        // Ouvrir la modal d'ajout
        function openAddModal() {
            modalTitle.textContent = 'Nouvel Appel d\'Offres';
            aoForm.reset();
            document.getElementById('editId').value = '';
            aoModal.style.display = 'flex';
        }

        // Ouvrir la modal d'édition
        function openEditModal(id) {
            const item = aoData.find(ao => ao.id === id);
            if (item) {
                modalTitle.textContent = 'Modifier l\'Appel d\'Offres';
                document.getElementById('editId').value = item.id;
                document.getElementById('exercise').value = item.exercise;
                document.getElementById('daoNumber').value = item.daoNumber;
                document.getElementById('object').value = item.object;
                document.getElementById('status').value = item.status;
                document.getElementById('observations').value = item.observations || '';
                aoModal.style.display = 'flex';
            }
        }

        // Fermer la modal
        function closeAoModal() {
            aoModal.style.display = 'none';
        }

        // Gestion de la soumission du formulaire
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const id = document.getElementById('editId').value;
            const exercise = document.getElementById('exercise').value;
            const daoNumber = document.getElementById('daoNumber').value;
            const object = document.getElementById('object').value;
            const status = document.getElementById('status').value;
            const observations = document.getElementById('observations').value;
            
            try {
                if (id) {
                    // Modification
                    await db.collection('appelsOffres').doc(id).update({
                        exercise,
                        daoNumber,
                        object,
                        status,
                        observations,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showMessage('Appel d\'offres modifié avec succès!', 'success');
                } else {
                    // Ajout
                    await db.collection('appelsOffres').add({
                        exercise,
                        daoNumber,
                        object,
                        status,
                        observations,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showMessage('Appel d\'offres ajouté avec succès!', 'success');
                }
                
                closeAoModal();
            } catch (error) {
                console.error('Erreur lors de l\'enregistrement:', error);
                showMessage('Erreur lors de l\'enregistrement: ' + error.message, 'error');
            }
        }

        // Mise à jour du statut
        async function updateStatus(id, newStatus) {
            try {
                await db.collection('appelsOffres').doc(id).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showMessage('Statut mis à jour avec succès!', 'success');
            } catch (error) {
                console.error('Erreur lors de la mise à jour du statut:', error);
                showMessage('Erreur lors de la mise à jour du statut: ' + error.message, 'error');
            }
        }

        // Suppression d'un appel d'offres
        async function deleteAo(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet appel d\'offres ?')) {
                try {
                    await db.collection('appelsOffres').doc(id).delete();
                    
                    // Supprimer également les alertes associées
                    const alertToDelete = alertData.find(alert => alert.daoId === id);
                    if (alertToDelete) {
                        await db.collection('alertes').doc(alertToDelete.id).delete();
                    }
                    
                    showMessage('Appel d\'offres supprimé avec succès!', 'success');
                } catch (error) {
                    console.error('Erreur lors de la suppression:', error);
                    showMessage('Erreur lors de la suppression: ' + error.message, 'error');
                }
            }
        }

        // Mettre à jour la liste déroulante des DAO pour les alertes
        function updateAlertDaoSelect() {
            alertDaoSelect.innerHTML = '<option value="">Choisir un appel d\'offres</option>';
            aoData.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.daoNumber} - ${item.object}`;
                alertDaoSelect.appendChild(option);
            });
        }

        // Gestion de l'ajout d'alerte
        async function handleAlertSubmit(e) {
            e.preventDefault();
            
            const daoId = alertDaoSelect.value;
            if (!daoId) {
                showMessage('Veuillez sélectionner un appel d\'offres', 'error');
                return;
            }
            
            // Vérifier si l'alerte existe déjà
            if (alertData.some(alert => alert.daoId === daoId)) {
                showMessage('Cet appel d\'offres est déjà dans la liste des alertes', 'error');
                return;
            }
            
            const daoItem = aoData.find(item => item.id === daoId);
            if (daoItem) {
                try {
                    await db.collection('alertes').add({
                        daoId: daoId,
                        daoNumber: daoItem.daoNumber,
                        object: daoItem.object,
                        comment: '',
                        dateAdded: new Date().toISOString(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alertForm.reset();
                    showMessage('Alerte ajoutée avec succès!', 'success');
                } catch (error) {
                    console.error('Erreur lors de l\'ajout de l\'alerte:', error);
                    showMessage('Erreur lors de l\'ajout de l\'alerte: ' + error.message, 'error');
                }
            }
        }

        // Rendu des alertes
        function renderAlerts() {
            alertsList.innerHTML = '';
            
            if (alertData.length === 0) {
                alertsList.innerHTML = '<p style="text-align: center; padding: 20px;">Aucune alerte définie</p>';
                return;
            }
            
            alertData.forEach(alert => {
                const alertElement = document.createElement('div');
                alertElement.className = 'alert-item';
                alertElement.innerHTML = `
                    <div class="alert-info">
                        <h4>${alert.daoNumber}</h4>
                        <p>${alert.object}</p>
                        <p><small>Ajouté le: ${new Date(alert.dateAdded).toLocaleDateString('fr-FR')}</small></p>
                        <div class="form-group" style="margin-top: 10px;">
                            <label for="comment-${alert.id}">Commentaire</label>
                            <textarea id="comment-${alert.id}" placeholder="Ajouter un commentaire..." style="width: 100%;">${alert.comment || ''}</textarea>
                        </div>
                    </div>
                    <div class="alert-actions">
                        <button class="btn btn-success save-comment-btn" data-id="${alert.id}">
                            <i class="fas fa-save"></i> Valider
                        </button>
                        <button class="btn btn-primary edit-comment-btn" data-id="${alert.id}">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                        <button class="btn btn-danger delete-alert-btn" data-id="${alert.id}">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                `;
                alertsList.appendChild(alertElement);
            });
            
            // Ajouter les écouteurs d'événements pour les boutons d'alerte
            document.querySelectorAll('.save-comment-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const comment = document.getElementById(`comment-${id}`).value;
                    saveAlertComment(id, comment);
                });
            });
            
            document.querySelectorAll('.delete-alert-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    deleteAlert(id);
                });
            });
        }

        // Sauvegarder le commentaire d'une alerte
        async function saveAlertComment(id, comment) {
            try {
                await db.collection('alertes').doc(id).update({
                    comment: comment,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showMessage('Commentaire sauvegardé avec succès!', 'success');
            } catch (error) {
                console.error('Erreur lors de la sauvegarde du commentaire:', error);
                showMessage('Erreur lors de la sauvegarde du commentaire: ' + error.message, 'error');
            }
        }

        // Supprimer une alerte
        async function deleteAlert(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette alerte ?')) {
                try {
                    await db.collection('alertes').doc(id).delete();
                    showMessage('Alerte supprimée avec succès!', 'success');
                } catch (error) {
                    console.error('Erreur lors de la suppression de l\'alerte:', error);
                    showMessage('Erreur lors de la suppression de l\'alerte: ' + error.message, 'error');
                }
            }
        }

        // Impression PDF
        function printPdf(type) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Titre du document
            doc.setFontSize(16);
            let title = 'Suivi des Appels d\'Offres';
            if (type === 'inprogress') title = 'Appels d\'Offres en Cours d\'Ouverture';
            if (type === 'completed') title = 'Appels d\'Offres Achevés';
            doc.text(title, 14, 15);
            
            // Date de génération
            const today = new Date();
            const dateStr = today.toLocaleDateString('fr-FR');
            doc.setFontSize(10);
            doc.text(`Généré le: ${dateStr}`, 14, 22);
            
            // En-têtes du tableau
            const headers = [['Exercice', 'DAO N°', 'Objet', 'État d\'Avancement', 'Observations']];
            
            // Données du tableau
            let data = [];
            if (type === 'overview') {
                data = filteredData.map(item => [
                    item.exercise,
                    item.daoNumber,
                    item.object,
                    item.status,
                    item.observations || ''
                ]);
            } else if (type === 'inprogress') {
                const inprogressStatuses = [
                    "examen des dossier administratifs et technique",
                    "examen de la documentation technique",
                    "examen des offres techniques",
                    "examen des offres financières",
                    "demande de complément envoyée",
                    "complément de dossier reçu à examiner",
                    "complément de dossier encours d'examination",
                    "échantillons envoyées à la sous commission"
                ];
                data = aoData.filter(item => inprogressStatuses.includes(item.status))
                            .map(item => [
                                item.exercise,
                                item.daoNumber,
                                item.object,
                                item.status,
                                item.observations || ''
                            ]);
            } else if (type === 'completed') {
                const completedStatuses = [
                    "marché en cours d'élaboration",
                    "marché envoyé à la société pour signature",
                    "marché envoyé pour signature de la partie technique",
                    "marché déposé pour signature du directeur",
                    "marché envoyé au Contrôleur d'Etat pour visa",
                    "marché visé reçu",
                    "marché approuvé notifié à la société",
                    "ordre de service de commencement à notifier",
                    "marché envoyé au service utilisateur"
                ];
                data = aoData.filter(item => completedStatuses.includes(item.status))
                            .map(item => [
                                item.exercise,
                                item.daoNumber,
                                item.object,
                                item.status,
                                item.observations || ''
                            ]);
            }
            
            // Générer le tableau
            doc.autoTable({
                head: headers,
                body: data,
                startY: 30,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [44, 62, 80] },
                columnStyles: {
                    0: { cellWidth: 20 },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 50 },
                    3: { cellWidth: 50 },
                    4: { cellWidth: 40 }
                }
            });
            
            // Télécharger le PDF
            doc.save(`suivi_appels_offres_${type}.pdf`);
        }

        // Export Excel
        function exportToExcel(type) {
            // Préparer les données
            let data = [];
            if (type === 'overview') {
                data = filteredData.map(item => ({
                    'Exercice': item.exercise,
                    'DAO N°': item.daoNumber,
                    'Objet': item.object,
                    'État d\'Avancement': item.status,
                    'Observations': item.observations || ''
                }));
            } else if (type === 'inprogress') {
                const inprogressStatuses = [
                    "examen des dossier administratifs et technique",
                    "examen de la documentation technique",
                    "examen des offres techniques",
                    "examen des offres financières",
                    "demande de complément envoyée",
                    "complément de dossier reçu à examiner",
                    "complément de dossier encours d'examination",
                    "échantillons envoyées à la sous commission"
                ];
                data = aoData.filter(item => inprogressStatuses.includes(item.status))
                            .map(item => ({
                                'Exercice': item.exercise,
                                'DAO N°': item.daoNumber,
                                'Objet': item.object,
                                'État d\'Avancement': item.status,
                                'Observations': item.observations || ''
                            }));
            } else if (type === 'completed') {
                const completedStatuses = [
                    "marché en cours d'élaboration",
                    "marché envoyé à la société pour signature",
                    "marché envoyé pour signature de la partie technique",
                    "marché déposé pour signature du directeur",
                    "marché envoyé au Contrôleur d'Etat pour visa",
                    "marché visé reçu",
                    "marché approuvé notifié à la société",
                    "ordre de service de commencement à notifier",
                    "marché envoyé au service utilisateur"
                ];
                data = aoData.filter(item => completedStatuses.includes(item.status))
                            .map(item => ({
                                'Exercice': item.exercise,
                                'DAO N°': item.daoNumber,
                                'Objet': item.object,
                                'État d\'Avancement': item.status,
                                'Observations': item.observations || ''
                            }));
            }
            
            // Créer un classeur
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);
            
            // Ajouter la feuille au classeur
            let sheetName = 'Appels d\'Offres';
            if (type === 'inprogress') sheetName = 'Ouverture en cours';
            if (type === 'completed') sheetName = 'DAO achevés';
            
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            
            // Générer le fichier Excel et le télécharger
            XLSX.writeFile(wb, `suivi_appels_offres_${type}.xlsx`);
        }
    </script>
    
    <!-- Font Awesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</body>
</html>
